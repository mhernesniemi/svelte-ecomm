
# Integrations Overview

Hoikka includes PostgreSQL-native utilities for integrating external systems (ERP, PIM, etc.) without Redis or other external dependencies.

## Why PostgreSQL?

| Aspect         | Redis/BullMQ       | PostgreSQL       |
| -------------- | ------------------ | ---------------- |
| Persistence    | Requires config    | Built-in         |
| Transactions   | Separate from DB   | Same transaction |
| Infrastructure | Additional service | Already have it  |
| Throughput     | ~10,000 jobs/sec   | ~1,000 jobs/sec  |
| Complexity     | More moving parts  | Single database  |

For most e-commerce workloads, PostgreSQL handles job queues easily.

## Available Utilities

### Job Queue

PostgreSQL-backed job queue with automatic retry:

```typescript
import { enqueue, registerHandler, startWorker } from "$lib/server/integrations";

registerHandler("email.send", async (payload) => {
	await sendEmail(payload.to, payload.subject);
});

await enqueue("email.send", { to: "user@example.com", subject: "Hello" });
```

### Events

Two modes - in-memory (immediate) or persistent (via queue):

```typescript
import { events, onPersistent, emitPersistent } from '$lib/server/integrations';

// In-memory (non-critical)
events.on('order.paid', async ({ orderId }) => { ... });

// Persistent (critical, with retry)
onPersistent('order.paid', async ({ orderId }) => { ... });
```

### Sync Runner

Reusable pattern for syncing external data:

```typescript
import { runSync, registerSyncJob, scheduleSyncJob } from "$lib/server/integrations";

const inventorySync = {
	name: "erp-inventory",
	fetchExternal: () => erpClient.getInventory()
	// ...
};

await scheduleSyncJob("erp-inventory", syncIntervals.hours(1));
```

### Webhooks

Handle incoming webhooks with signature verification:

```typescript
import { createWebhookHandler, signatureVerifiers } from '$lib/server/integrations';

export const POST = createWebhookHandler({
  secret: process.env.WEBHOOK_SECRET,
  verifySignature: signatureVerifiers.hmacHeader('x-signature'),
  handlers: { ... }
});
```

### Retry

Retry failed operations with exponential backoff:

```typescript
import { withRetry } from "$lib/server/integrations";

await withRetry(() => externalApi.call(), { maxAttempts: 3 });
```
