
# Architecture

Hoikka follows a service-oriented architecture with clear separation of concerns.

## Service Pattern

Business logic lives in singleton services:

```typescript
// src/lib/server/services/products.ts
class ProductService {
  async getById(id: number) { ... }
  async create(data: NewProduct) { ... }
  async update(id: number, data: Partial<Product>) { ... }
}

export const productService = new ProductService();
```

Usage in routes:

```typescript
// src/routes/admin/products/[id]/+page.server.ts
import { productService } from "$lib/server/services/products";

export const load = async ({ params }) => {
	const product = await productService.getById(params.id);
	return { product };
};
```

## Provider Pattern

Payments and shipping use a provider pattern for easy swapping:

```typescript
interface PaymentProvider {
	code: string;
	createPayment(order: Order): Promise<PaymentInfo>;
	confirmPayment(transactionId: string): Promise<PaymentStatus>;
}

// Register multiple providers
const PROVIDERS = new Map<string, PaymentProvider>([
	["stripe", new StripeProvider()],
	["klarna", new KlarnaProvider()]
]);
```

## Data Flow

```
Route (load/action)
    ↓
Service (business logic)
    ↓
Database (Drizzle ORM)
```

## Form Actions

Most mutations use SvelteKit form actions with progressive enhancement:

```typescript
// +page.server.ts
export const actions = {
	update: async ({ request, params }) => {
		const formData = await request.formData();
		await productService.update(params.id, {
			name: formData.get("name")
		});
	}
};
```

```svelte
<!-- +page.svelte -->
<form method="POST" action="?/update" use:enhance>
	<input name="name" value={product.name} />
	<button type="submit">Save</button>
</form>
```
