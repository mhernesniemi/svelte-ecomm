
# Providers

Hoikka uses a provider pattern for payments and shipping, making it easy to add new integrations.

## Payment Providers

### Interface

```typescript
interface PaymentProvider {
	code: string;
	createPayment(order: Order): Promise<PaymentInfo>;
	confirmPayment(transactionId: string): Promise<PaymentStatus>;
	refundPayment?(transactionId: string, amount: number): Promise<RefundInfo>;
}
```

### Adding a Provider

```typescript
// src/lib/server/services/payments/providers/klarna.ts
export class KlarnaProvider implements PaymentProvider {
	code = "klarna";

	async createPayment(order: Order): Promise<PaymentInfo> {
		// Create Klarna payment session
		const session = await klarnaClient.createSession({
			amount: order.total,
			currency: "EUR"
			// ...
		});

		return {
			transactionId: session.id,
			redirectUrl: session.redirect_url,
			status: "pending"
		};
	}

	async confirmPayment(transactionId: string): Promise<PaymentStatus> {
		const payment = await klarnaClient.getPayment(transactionId);
		return payment.status === "CAPTURED" ? "settled" : "pending";
	}
}
```

Register it:

```typescript
// src/lib/server/services/payments/index.ts
import { KlarnaProvider } from "./providers/klarna";

PROVIDERS.set("klarna", new KlarnaProvider());
```

## Shipping Providers

### Interface

```typescript
interface ShippingProvider {
	code: string;
	getRates(order: Order): Promise<ShippingRate[]>;
	createShipment(order: Order): Promise<ShipmentInfo>;
	trackShipment(trackingNumber: string): Promise<ShipmentStatus>;
}
```

### Adding a Provider

```typescript
// src/lib/server/services/shipping/providers/dhl.ts
export class DhlProvider implements ShippingProvider {
	code = "dhl";

	async getRates(order: Order): Promise<ShippingRate[]> {
		const rates = await dhlClient.getRates({
			from: WAREHOUSE_ADDRESS,
			to: order.shippingAddress,
			weight: calculateWeight(order)
		});

		return rates.map((rate) => ({
			id: rate.serviceCode,
			name: rate.serviceName,
			price: rate.totalPrice,
			estimatedDays: rate.transitDays
		}));
	}

	// ... other methods
}
```

## Built-in Providers

### Payments

- **Stripe** - Full integration with Payment Intents
- **Mock** - For development/testing

### Shipping

- **Posti** - Finnish postal service
- **Matkahuolto** - Finnish parcel service
